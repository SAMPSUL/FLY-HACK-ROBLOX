-- Fly Toggle for Roblox Studio / your own game
-- Place as LocalScript: StarterPlayer > StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local flying = false
local speed = 60 -- studs/sec (säädä +- näppäimillä)
local keys = {W=false,A=false,S=false,D=false,Up=false,Down=false}

local function getHRP()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart"), char:WaitForChild("Humanoid")
end

local function setKey(input, down)
    if input.KeyCode == Enum.KeyCode.W then keys.W = down
    elseif input.KeyCode == Enum.KeyCode.A then keys.A = down
    elseif input.KeyCode == Enum.KeyCode.S then keys.S = down
    elseif input.KeyCode == Enum.KeyCode.D then keys.D = down
    elseif input.KeyCode == Enum.KeyCode.Space then keys.Up = down
    elseif input.KeyCode == Enum.KeyCode.LeftShift then keys.Down = down
    end
end

-- Toggle fly with F, adjust speed with +/-
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.F then
        flying = not flying
        local hrp, hum = getHRP()
        if flying then
            hum:ChangeState(Enum.HumanoidStateType.Physics)
            hum.PlatformStand = true
            -- nollaa putoamisnopeus heti
            hrp.AssemblyLinearVelocity = Vector3.zero
            print("[Fly] ON  | Speed:", speed)
        else
            hum.PlatformStand = false
            -- palautetaan liike hallinta humanoidille
            hrp.AssemblyLinearVelocity = Vector3.zero
            print("[Fly] OFF")
        end
    elseif input.KeyCode == Enum.KeyCode.Equals or input.KeyCode == Enum.KeyCode.KeypadPlus then
        speed = math.clamp(speed + 10, 10, 300)
        if flying then print("[Fly] Speed:", speed) end
    elseif input.KeyCode == Enum.KeyCode.Minus or input.KeyCode == Enum.KeyCode.KeypadMinus then
        speed = math.clamp(speed - 10, 10, 300)
        if flying then print("[Fly] Speed:", speed) end
    else
        setKey(input, true)
    end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
    if gpe then return end
    setKey(input, false)
end)

-- Päivitä liike joka frame
RunService.RenderStepped:Connect(function(dt)
    if not flying then return end
    local hrp, hum = getHRP()

    -- Kameran suuntavektorit
    local look = camera.CFrame.LookVector
    local right = camera.CFrame.RightVector

    -- Poista Y-komponentti sivuttais/eteenliikkeestä (XZ-taso)
    look = Vector3.new(look.X, 0, look.Z).Unit
    right = Vector3.new(right.X, 0, right.Z).Unit

    -- Syöte -> liikesuunta
    local dir = Vector3.zero
    if keys.W then dir += look end
    if keys.S then dir -= look end
    if keys.A then dir -= right end
    if keys.D then dir += right end
    if keys.Up then dir += Vector3.yAxis end
    if keys.Down then dir -= Vector3.yAxis end

    if dir.Magnitude > 0 then
        dir = dir.Unit
    end

    -- Aseta nopeus
    hrp.AssemblyLinearVelocity = dir * speed
    -- Pidä orientaatio siistinä (vain kameran yaw suuntaan)
    local camCF = camera.CFrame
    local _, yaw, _ = camCF:ToEulerAnglesYXZ()
    local pos = hrp.CFrame.Position
    hrp.CFrame = CFrame.new(pos) * CFrame.Angles(0, yaw, 0)
end)

-- Turva: jos hahmo spawnaa uudelleen, kytke fly pois päältä
player.CharacterAdded:Connect(function(char)
    flying = false
end)
